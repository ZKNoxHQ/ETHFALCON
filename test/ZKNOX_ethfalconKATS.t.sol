pragma solidity ^0.8.25;

import {Test, console} from "forge-std/Test.sol";
import "../src/ZKNOX_falcon_encodings.sol";
import "../src/ZKNOX_ethfalcon.sol";
import "../src/ZKNOX_display.sol";

contract ETHFalconKATS_Test is Test {
    ZKNOX_ethfalcon falcon = new ZKNOX_ethfalcon();

    //kat vector 0 from NIST round3 submission
    function test_kats_vector0_from_c() public {
        // forgefmt: disable-next-line
        bytes memory pk=hex"091AEA06CB196228F411721A5E130A03742FB2079C21951F68149A1232102418071340147C00C522E4292420061231252800F12FD714262E9A29E61D6304340BD409C90E060D642018188130001D9F0A5A21512B17154C08C3012E04FC24EC069E0996185B0E6316B80D1A18281FFE029A2A080F1729FD02262AC81F6007AF171714892BAB095B188823C0090309592D6320F528451FA8155A250C0187035609C61E3B1304096729D31EC613BC0A9F0CBC2FB111D624560C4401CE2EC91E49230214CC18BC25531BF5034510280A431C2D0C2707B72C0A26820DD10D460F68177425651CB71F9B116D08341B4C0EAB189D0C832BE5299C2BB91B5B0D5C07BF2C8B2044200C2EC122E41CCD125403B71EF82BE5099F233711DC1F1A073F031E26BC2DC21756009C1F941A121B7F0DCD240B2DA70A9B14622A38029B2B0A1C9D1EE813A702212BB608F52FEE2F4328FB1E8E1AA9025520410FAF20032018110613031DB12F6E1D4516991C7D07AD2F291CA00320019823CC17A121C82A290A62125E28550DBC24090E1201490A2D107700F123F60D9027DB05091DD004E2005D270722EA1A1F27900A8B0AEA1C012DF623A02DCE24C229AD0F5122EF2E3415740AF208131DC00C72005C1CB30B641E500B1E19E50D8526AB2BCE28372B5807581B92122F19691ED70B9712A0176E23E41046272B20AB13B612D22BBA1F7E2D40296D2BE005741D8C05C1062711D92102209413C1047F2E07251110832678246E18FA1B0917031356206310DF137905DF0E8D0FE92EAF04B82DBB1FAE0E49212016122C6429611F691FB417930DF824E427D82EA102AA218719C5011C1C6D031B1F7E0AEC264616832B6A0E9C09DE1E4A2AFA2BE422AA2577159202DC2B4B22152C6E18CA060B043D1CC02114000319C62F38225818722D1924002B6E015B2A072A7912511D192840062229B220D407132A6203081DC1094419E31C9018F011002D9F29C600F72F221AFA153E00820912242F11B91B5A2F3A07B5029F16FE2FA317BB2EB212651F2F1A1D2DF025570A9301D02EBA230411EA065A0AC4036B2200037E0BD3126D114F29E904C9197727A4169B0A2922EB202625C7113804E218381F2B2F6A074F06B127480E771B472CC508C5251B1E01200508B725CF163C160613B11F3405D11BA00CD724A302A30E0D23A20EA01C060232075015621B9D2871217E1EDC07862D9D14FB2CC225811A040B9E049B0FCC16A909321BA7184225CE074B18D61B5D2DD5210B29A2298C1ED7283F0496282508B813B80FEE0F86138A297B1CED1D54129D015B19410A1324E72AB11657164F2BD01FAB096A064A15D31E5211011E8720CE1877221B12FC01FE203105420252104F2DFA04560466199E2FF720E12DAF1F2D0C9B2142192F25B8205214CC05992AD801D4151A08E225320C3E";// forgefmt: disable-next-line
        bytes memory sm=hex"040133B3C07507E4201748494D832B6EE2A6C93BFF9B0EE343B550D1F85A3D0DE0D704C6D17842951309D81C4D8D734FCBFBEADE3D3F8A039FAA2A2C9957E835AD55B22E75BF57BB556AC8292FD42EF7006B2FF12FDD0053007C2FCB004D2EFD011F2F392FF5004B2FD42FAE00EB2F9300402EC72F0F00482FC800072FC72F4C012B0032008A2F9801192F8F00CE2F692F7600E000572F342FE200512E6A2F3B00DF2FE42F8C00BA2F6C2FEB2EE52F16000C2F8800A1010700CC001F001E00BD0065008C005E2FF72F8D2FF9008C00932F642FE801062F892F5700250106006D0015004A2F242FD72FE22FF62F3E2FA22F392FAF001701702FA900F72FB32F6D2FF92EED2FC7005D2FC400972F902F3000212FB501522FFA2F9D002600AA2F4E00672FDD00382FE82FCC00892EA800032FCD00CF2F6D012230002F6A2FF500482F5D2F17011800142EF92FAF2F2A00000035020A003E2EF4010B002300072FA92F9E000C2F112F6F00472FAF2F342F762FB700802F6200572FA4005F001D00022F7B2F802F402FC300EE2F8400F5002F002E2FA700A4009F2FE700F300CE005D00622F952FDA001A2F94006B2EC0005C000E2FF500132FD9001F00DE2F622F8C000E2FBA2FAB2EDB006300342FE72FC92F352EF42EC000C32E592F3B2F2100932FE12FFC2FEB01952F442FD42FAB2FF52F892F422F132F83009B00902F8200262FBE009800132EDB2FCC00AD00392EE52F9A005100E0004F2E812EE300182FAE00B82F7C2F6C2FED009D00022F5902AC00212FDE002200A1007E002A000E00C92FE300512FF4003C0036004B2FD800312F992FD22F53004C00D32F9A00112F7400C42ED62E602F8300402FA32F12001D2FBD2FC62F432EE000F22F8C2FDF00A12FC1012A003B2FCD0010006000C400280085006B004B009C002D2F81006500E22FE22F852F3400592FED002B005100F9005B00110117007A2FD12FA7013A2F1F2EEB007B2F1B2FFD011C0105002B2FCF2F9D007C003200AE00D400AD2F6D2F7D2F922F0D0048007C004700680090011A2F832ED00084003500372FB400552F2201902F602F172FE000162EE92EF801892F9E009300752F3100592F812F3A2FE8015F003D000F2F9100782F0F2F5E2FD1009D2F7600482F942EA72FCA2FA52F4C00E201692F9F00F42EE800E5000A01032FE80077004400A22FA2002A006500442F3F009A008500F62F41004C2FCA011A2FC72FFD2FBE00F70023007E2F0100052FF5001600032FA92FF12F9A00732F47005400E300F62E712F2A0068006C2F76013200ED00F32F942FC32F782F9A2FBB003101892FE82F862F632F232FF82F460168000800752FD000EB00B02F6100D92FA6002F2FB62F780129002C2F7E00872FF12FC92F2000ED2FD40052005D000A2FA72EF101352F4300342F7500C600742FC62FBD2FF02FEC2FC42F922FA900812F5D00842F842EE8013F0127000F006A2EE1008300F800D40078002800E2003700302F402E872FED2DE62EF62FFA2FC52FE82F8F2FE92FE32F182F41";

        bytes memory salt = new bytes(40);
        for (uint256 k = 0; k < 40; k++) {
            salt[k] = sm[2 + k];
        }
        bytes memory message = new bytes(33);
        for (uint256 k = 0; k < 33; k++) {
            message[k] = sm[2 + 40 + k];
        }
        uint256[] memory s2 = new uint256[](512);
        for (uint256 k = 0; k < 512; k++) {
            s2[k] = uint256(uint8(sm[2 + 40 + 33 + 1 + 2 * k])) << 8 | uint256(uint8(sm[2 + 40 + 33 + 1 + 2 * k + 1]));
        }
        uint256[] memory kpub = new uint256[](512);
        for (uint256 k = 0; k < 512; k++) {
            kpub[k] = uint256(uint8(pk[1 + 2 * k])) << 8 | uint256(uint8(pk[1 + 2 * k + 1]));
        }

        uint256[] memory cs2;

        uint256[] memory ntth = _ZKNOX_NTT_Compact(_ZKNOX_NTTFW_vectorized(kpub));

        cs2 = _ZKNOX_NTT_Compact(s2);

        bool result = falcon.verify(message, salt, cs2, ntth);
        console.log("result", result);
        assertEq(true, result);
    }

    //kat vector 1 from NIST round3 submission
    function test_kats_vector1_from_c() public {
        // forgefmt: disable-next-line
        uint256 mlen = 66;
        bytes memory pk=hex"092EB30C8D1B2416C92B442E3E126201F70CAE04870339197624871197280312262AE202540C36278F066C0E7A048429EC2DCE1D4A01711EBB00061F0C1843214515A80B4C1E920E2E1332051D0BA2257405F908F9062D16DC1817125104D111C32C41120F2070016A18F12F2D22092B902C1318B029E42272181F23980A6B1F4B02700CAF2C470F2F224F056B099020F812401FF01CBE1100004D136808B51127249903DF13B724B610800AE02FE02B7D119E12EE2B8D171F140629A8053929F207A10DC218D117B904E517881ABE1DA21660003E214E2C232D3528291C5407B816FF2B1418040B4B033713F002BE006C2F552A32261F23850CAB23C71E50058205711DB0108026AC1F7E258E296C17B82BA41E06281F1B250F881EFF0D872C060D042B221FF82CF9164B06B42221189F028E27FB268C00B10C7F04AE1D570E16285514BE1B380F4E20C01BB805382D1900E8209F01D10687009214981DAB094121FF0E081957021307CA244821930D6C1DDE03EA0B792C1010B128E3227D2D0623BB021927721B6E24BB1D441A6A123A1A0E2B1C125517C127670C9A0E082B6222182A9E177C2B150BE218170BCF05FD29412C2B087810ED0E7301CE2FD40B88271213E12D9814A50F0C0EE72FA50ABE167603C21C0D10AD124322F9081725601EBA13280C8B060A2B2B0EA92BCA21210518269612DA0AF1012A23B3130629E02B8608530522117102CE2CE617D50F4011462BE4097F17AF10860FFD019E22F6078C2D85060C1AAB00CB00FA256F0C55013F0F8C060229EA1B450CB20F8D1DF90C710076191A0487184A217215D710BA1BC80C2216AE02A518BC0EEF1B480ED20E76208221F71E671C0712C224DA0DBE14AB0BBE03C81920014D1ADD0A1B26EB22390F1610FA122B0AB30BE828ED12731E980A43111504961B992B7D2995257B16F726340ED6187104712863111B004405780D9816AD134E075F2AC60577008E23CF12A70F580574060D28AD077E2700079907871B3510D5225D2569173E17151CE725D40BE9284C147210772A5727EB0C6E07BA060208822C3319FA03D714F21B5616AF05FC22DD0270188318412F591E4803B00744070721030802127E1B960C200FD5088702502B9005F529740C310ADB2A891C6A19830931142308E008CC26A01A422AA71F3C24200BCB133D1BD70F7F25C020332AAA19B80FAE017608F20EDD27322E90094C0B4C0FD11B492AC4091C291F289503B71D472FF20084135822DD2A1611BB0C6A285E061D2D5315AD2EFF13AE045023F329E328340B7B2E7017A60BF82F6A027306942037131A1C6524F11D75171218F72D150C01215D18C912D600D4095F166F1C7A2D38081722CC1C5C032F061916491909072C17CD0E18150100C60CDA1C8305F01FC31D460B1618DE040A219827110F8E009A1C030C1B";// forgefmt: disable-next-line
        bytes memory sm=hex"040108E25538484CD7F1613248FE6C9F6B4EC14BE684C6DEFDD1E41333B6E9052AC4340E314EEA2C99F7225D5CE2CEAC61930A07503FB59F7C2F936A3E075481DA3CA299A80F8C5DF9223A073E7B90E02EBF98CA2227EBA38C1AB2568209E46DBA961869C6F83983B17DCD49292E00000C2FC200642FFF00082F7A00E8000600412EC82FF02F31005D00932FD7001500A500732FC100512FEA2FAA0112005700D22F10000900CF2FF700E12F4D2FB30066001D2F7C006E00652F29004D2FDB2F572EBA2F2000C500362F9300022FE22FCF00EB008A00D42FC92FB92FD900112EC50048011100012FB22E692EC10176006500192F57001F003B2F552EED2F34001A2FA8008401802FA1007D018E2FD000ED2F7A00822F432F892F5800162FF600E22F9A00372FA200F80084010800932FE8007D2F652F76006F2E1F2F4E2FA100C02FAE00272FD02EFD006E013E007C2F652FCB00392FB800532F46002E005C2FD700A5003A2FAE008A2EA80096003B2FFB2FB4003D009C2F7D2FCF2E8600842FE22EFC2EDA000A2F8200610061004600ED0036004F2FBF2FF000882FC100432FA62F582EA500CB2E56007F2FEC01352FB5004800202ECC2F75000E2FD92F3400B8004800C22F252F8D2F182F5100B1005B2EAA00B000AB00212ED000B22F6D01A82F0B2EC0007C013F00A3006E2FE100E92F3800F02F9F003D01342EB700542F6F2FB7001200350027009B2EA2014100B4009E2FC92F972F3B002C00DA00052FCF00CA2FF9011B00682ED200992F5F2FB92F242F6A00F42F8330002FF42F5200D82E99003B2F612F922FCD2EE4006B00EC2EF001B32F972F762F3B2FE42F19000E009C00802F892F9130002FE22F222F452FA300092F632FFB001D004C2EDA2FB300DF2EE400132F442F3C2F300017011901692FE22F8C2FC20090010D004C000700912FCC01812FE22FC72F6D2EFE2F51009B2EEF2F3430002F5A00452F870012008F2F93000D2FF62F45005B2F392FDB2FDB2FA72FD92FE0001900F72F70002200F700BD2F432FA20005005F002F0199005E00272EE32EAB2F112F1B010400002EBA00EB0050005D2FB52F4700E60037006900982FCE2F0A00252ECC2F132FDD2F642F5901102FB72FB1006700612FEC002B00C62FA52EDE2F712FD4001B2FFF2FE42FEB00032F992FC900822F7B2EE70067016F2FC42F250016001C009300112F9100062F622EFA2FC52F722F682F9A005A00652F7C2F422FCE00E82F372F5B001B014700782EEA004B015E2FB00021016700652F592FB5010E00AA004C2FE62FE2003A008B2F4C00682F9F00A8000F2F9B002801722F532F5F002100C100322F8D2F95008800BF2F8D00072F91006E00562FFD00DA2FE02FD9009000E800F700000097008E2FA8005C2FE400DE2FF7004500A500282FBC2E9B00932FAC2ED22ECC3000011F2E872F7A2FE42FF82FA62FF02FC82F582F42008D2F612F9200332FC22ED52EFA0025004C001F00C52F3D2E40007400562F3D006601002F9C2FBC00A700CF0039005D005500812FEF2E9E00652EEC2FCB00FC2F202FEC00F5003E2F9F00922EB52FCA00730028";

        bytes memory salt = new bytes(40);
        for (uint256 k = 0; k < 40; k++) {
            salt[k] = sm[2 + k];
        }
        bytes memory message = new bytes(mlen);
        for (uint256 k = 0; k < mlen; k++) {
            message[k] = sm[2 + 40 + k];
        }
        uint256[] memory s2 = new uint256[](512);
        for (uint256 k = 0; k < 512; k++) {
            s2[k] = uint256(uint8(sm[2 + 40 + mlen + 1 + 2 * k])) << 8 | uint256(uint8(sm[2 + 40 + mlen + 1 + 2 * k + 1]));
        }
        uint256[] memory kpub = new uint256[](512);
        for (uint256 k = 0; k < 512; k++) {
            kpub[k] = uint256(uint8(pk[1 + 2 * k])) << 8 | uint256(uint8(pk[1 + 2 * k + 1]));
        }

        uint256[] memory cs2;

        uint256[] memory ntth = _ZKNOX_NTT_Compact(_ZKNOX_NTTFW_vectorized(kpub));

        cs2 = _ZKNOX_NTT_Compact(s2);

        bool result = falcon.verify(message, salt, cs2, ntth);
        console.log("result", result);
        assertEq(true, result);
    }
}
