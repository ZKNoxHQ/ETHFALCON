pragma solidity ^0.8.25;

import {Test, console} from "forge-std/Test.sol";
import "../src/ZKNOX_falcon_encodings.sol";
import "../src/ZKNOX_ethfalcon.sol";
import "../src/ZKNOX_display.sol";

contract ETHFalconKATS_Test is Test {
    ZKNOX_ethfalcon falcon = new ZKNOX_ethfalcon();

    //kat vector 0 from NIST round3 submission
    function test_kats_vector0_from_c() public {
        // forgefmt: disable-next-line
        bytes memory pk=hex"091AEA06CB196228F411721A5E130A03742FB2079C21951F68149A1232102418071340147C00C522E4292420061231252800F12FD714262E9A29E61D6304340BD409C90E060D642018188130001D9F0A5A21512B17154C08C3012E04FC24EC069E0996185B0E6316B80D1A18281FFE029A2A080F1729FD02262AC81F6007AF171714892BAB095B188823C0090309592D6320F528451FA8155A250C0187035609C61E3B1304096729D31EC613BC0A9F0CBC2FB111D624560C4401CE2EC91E49230214CC18BC25531BF5034510280A431C2D0C2707B72C0A26820DD10D460F68177425651CB71F9B116D08341B4C0EAB189D0C832BE5299C2BB91B5B0D5C07BF2C8B2044200C2EC122E41CCD125403B71EF82BE5099F233711DC1F1A073F031E26BC2DC21756009C1F941A121B7F0DCD240B2DA70A9B14622A38029B2B0A1C9D1EE813A702212BB608F52FEE2F4328FB1E8E1AA9025520410FAF20032018110613031DB12F6E1D4516991C7D07AD2F291CA00320019823CC17A121C82A290A62125E28550DBC24090E1201490A2D107700F123F60D9027DB05091DD004E2005D270722EA1A1F27900A8B0AEA1C012DF623A02DCE24C229AD0F5122EF2E3415740AF208131DC00C72005C1CB30B641E500B1E19E50D8526AB2BCE28372B5807581B92122F19691ED70B9712A0176E23E41046272B20AB13B612D22BBA1F7E2D40296D2BE005741D8C05C1062711D92102209413C1047F2E07251110832678246E18FA1B0917031356206310DF137905DF0E8D0FE92EAF04B82DBB1FAE0E49212016122C6429611F691FB417930DF824E427D82EA102AA218719C5011C1C6D031B1F7E0AEC264616832B6A0E9C09DE1E4A2AFA2BE422AA2577159202DC2B4B22152C6E18CA060B043D1CC02114000319C62F38225818722D1924002B6E015B2A072A7912511D192840062229B220D407132A6203081DC1094419E31C9018F011002D9F29C600F72F221AFA153E00820912242F11B91B5A2F3A07B5029F16FE2FA317BB2EB212651F2F1A1D2DF025570A9301D02EBA230411EA065A0AC4036B2200037E0BD3126D114F29E904C9197727A4169B0A2922EB202625C7113804E218381F2B2F6A074F06B127480E771B472CC508C5251B1E01200508B725CF163C160613B11F3405D11BA00CD724A302A30E0D23A20EA01C060232075015621B9D2871217E1EDC07862D9D14FB2CC225811A040B9E049B0FCC16A909321BA7184225CE074B18D61B5D2DD5210B29A2298C1ED7283F0496282508B813B80FEE0F86138A297B1CED1D54129D015B19410A1324E72AB11657164F2BD01FAB096A064A15D31E5211011E8720CE1877221B12FC01FE203105420252104F2DFA04560466199E2FF720E12DAF1F2D0C9B2142192F25B8205214CC05992AD801D4151A08E225320C3E";// forgefmt: disable-next-line
        bytes memory sm=hex"040133B3C07507E4201748494D832B6EE2A6C93BFF9B0EE343B550D1F85A3D0DE0D704C6D17842951309D81C4D8D734FCBFBEADE3D3F8A039FAA2A2C9957E835AD55B22E75BF57BB556AC8292FD42EF7006B2FF12FDD0053007C2FCB004D2EFD011F2F392FF5004B2FD42FAE00EB2F9300402EC72F0F00482FC800072FC72F4C012B0032008A2F9801192F8F00CE2F692F7600E000572F342FE200512E6A2F3B00DF2FE42F8C00BA2F6C2FEB2EE52F16000C2F8800A1010700CC001F001E00BD0065008C005E2FF72F8D2FF9008C00932F642FE801062F892F5700250106006D0015004A2F242FD72FE22FF62F3E2FA22F392FAF001701702FA900F72FB32F6D2FF92EED2FC7005D2FC400972F902F3000212FB501522FFA2F9D002600AA2F4E00672FDD00382FE82FCC00892EA800032FCD00CF2F6D012230002F6A2FF500482F5D2F17011800142EF92FAF2F2A00000035020A003E2EF4010B002300072FA92F9E000C2F112F6F00472FAF2F342F762FB700802F6200572FA4005F001D00022F7B2F802F402FC300EE2F8400F5002F002E2FA700A4009F2FE700F300CE005D00622F952FDA001A2F94006B2EC0005C000E2FF500132FD9001F00DE2F622F8C000E2FBA2FAB2EDB006300342FE72FC92F352EF42EC000C32E592F3B2F2100932FE12FFC2FEB01952F442FD42FAB2FF52F892F422F132F83009B00902F8200262FBE009800132EDB2FCC00AD00392EE52F9A005100E0004F2E812EE300182FAE00B82F7C2F6C2FED009D00022F5902AC00212FDE002200A1007E002A000E00C92FE300512FF4003C0036004B2FD800312F992FD22F53004C00D32F9A00112F7400C42ED62E602F8300402FA32F12001D2FBD2FC62F432EE000F22F8C2FDF00A12FC1012A003B2FCD0010006000C400280085006B004B009C002D2F81006500E22FE22F852F3400592FED002B005100F9005B00110117007A2FD12FA7013A2F1F2EEB007B2F1B2FFD011C0105002B2FCF2F9D007C003200AE00D400AD2F6D2F7D2F922F0D0048007C004700680090011A2F832ED00084003500372FB400552F2201902F602F172FE000162EE92EF801892F9E009300752F3100592F812F3A2FE8015F003D000F2F9100782F0F2F5E2FD1009D2F7600482F942EA72FCA2FA52F4C00E201692F9F00F42EE800E5000A01032FE80077004400A22FA2002A006500442F3F009A008500F62F41004C2FCA011A2FC72FFD2FBE00F70023007E2F0100052FF5001600032FA92FF12F9A00732F47005400E300F62E712F2A0068006C2F76013200ED00F32F942FC32F782F9A2FBB003101892FE82F862F632F232FF82F460168000800752FD000EB00B02F6100D92FA6002F2FB62F780129002C2F7E00872FF12FC92F2000ED2FD40052005D000A2FA72EF101352F4300342F7500C600742FC62FBD2FF02FEC2FC42F922FA900812F5D00842F842EE8013F0127000F006A2EE1008300F800D40078002800E2003700302F402E872FED2DE62EF62FFA2FC52FE82F8F2FE92FE32F182F41";

        bytes memory salt = new bytes(40);
        for (uint256 k = 0; k < 40; k++) {
            salt[k] = sm[2 + k];
        }
        bytes memory message = new bytes(33);
        for (uint256 k = 0; k < 33; k++) {
            message[k] = sm[2 + 40 + k];
        }
        uint256[] memory s2 = new uint256[](512);
        for (uint256 k = 0; k < 512; k++) {
            s2[k] = uint256(uint8(sm[2 + 40 + 33 + 1 + 2 * k])) << 8 | uint256(uint8(sm[2 + 40 + 33 + 1 + 2 * k + 1]));
        }
        uint256[] memory kpub = new uint256[](512);
        for (uint256 k = 0; k < 512; k++) {
            kpub[k] = uint256(uint8(pk[1 + 2 * k])) << 8 | uint256(uint8(pk[1 + 2 * k + 1]));
        }

        uint256[] memory cs2;

        // uint256[] memory hashed = hashToPointRIP(message, salt);
        // console.log("HASHTOPOINTRIP");
        // for (uint256 i = 0 ; i < 10 ; i ++ ) {
        //     console.log("hashed[", i, "] = ", hashed[i]);
        // }

        uint256[] memory ntth = _ZKNOX_NTT_Compact(_ZKNOX_NTTFW_vectorized(kpub));

        cs2 = _ZKNOX_NTT_Compact(s2);

        console.log("ntth length:", ntth.length);
        console.log("salt:");
        console.logBytes(salt);

        console.log("message:");
        console.logBytes(message);

        Display_HexArray("ntt public key form", ntth);
        Display_HexArray("s2", cs2);

        bool result = falcon.verify(message, salt, cs2, ntth);
        console.log("result", result);
        assertEq(true, result);
    }
}
