from encoding import decompress
from falcon import SecretKey, PublicKey
from shake import SHAKE
from keccak_prng import KeccakPRNG
from scripts.sign_KAT import sign_KAT
from polyntt.poly import Poly
from falcon import HEAD_LEN, SALT_LEN, q

count = 0
seed = bytes.fromhex("061550234D158C5EC95595FE04EF7A25767F2E24CC2BC479D09D86DC9ABCFDE7056A8C266F9EF97ED08541DBD2E1FFA1")
mlen = 33
msg = bytes.fromhex("D81C4D8D734FCBFBEADE3D3F8A039FAA2A2C9957E835AD55B22E75BF57BB556AC8")
salt = bytes.fromhex("33B3C07507E4201748494D832B6EE2A6C93BFF9B0EE343B550D1F85A3D0DE0D704C6D17842951309")
expected_hash_NIST = [5856, 9672, 354, 9719, 7445, 6283, 10462, 8588, 85, 3840, 154, 4853, 9810, 2498, 6289, 11201, 10788, 1348, 4887, 9929, 6350, 11349, 9022, 8339, 1628, 6696, 7021, 7449, 11889, 6671, 6476, 8912, 5472, 9103, 11621, 4985, 11799, 7779, 6236, 4880, 3469, 2493, 455, 8968, 7869, 9871, 3795, 10502, 24, 9231, 1668, 10999, 5937, 10579, 6780, 1407, 149, 922, 884, 5092, 7485, 10910, 3231, 9806, 9181, 4821, 7829, 10197, 9857, 1682, 5559, 9831, 10176, 3765, 10055, 12080, 5137, 11767, 7822, 2386, 7572, 7172, 2543, 3735, 5842, 9635, 6402, 11416, 8387, 9006, 9905, 6464, 7783, 8087, 469, 5723, 8863, 1320, 4171, 4942, 8036, 7169, 1063, 1414, 4290, 4015, 2886, 5520, 7406, 6283, 1727, 757, 2589, 5012, 10398, 347, 2945, 4993, 3535, 12102, 4117, 10037, 9469, 3593, 607, 6667, 11300, 2911, 5494, 10477, 4953, 5479, 8012, 6745, 4327, 7739, 4946, 1830, 8740, 11249, 10418, 1337, 2159, 6103, 10419, 6852, 10918, 634, 2147, 11027, 115, 11934, 2008, 5283, 9696, 5339, 8111, 10592, 4456, 3920, 11139, 7080, 6830, 275, 11516, 7928, 8530, 7695, 1683, 11501, 5871, 11165, 7100, 810, 7857, 5717, 10166, 9130, 11194, 10671, 536, 737, 12248, 6353, 8544, 3937, 5034, 3917, 8711, 8462, 10378, 3165, 4493, 9024, 2140, 9035, 7460, 4719, 3552, 7015, 4469, 9174, 5994, 9150, 6422, 11130, 3000, 1976, 8802, 2033, 11441, 1864, 8543, 611, 2935, 11438, 2307, 5860, 5554, 741, 6519, 8885, 2954, 5716, 6994, 3536, 7164, 5280, 3461, 6095, 5498, 11397, 11592, 9323, 12119, 5137, 2923, 5547, 9278, 6730, 2513, 8428, 10364, 2322, 12010, 11719, 4476, 8565, 1958, 2343, 2126, 6759, 6207, 8633, 9496, 5827, 5339, 2665, 4457, 12239, 6369, 1174, 6305, 10726, 6062, 1470, 40, 3572, 5825, 9256, 3030, 8189, 4495, 10957, 7556, 10444, 3929, 3336, 7719, 7701, 3920, 3240, 5384, 6158, 10377, 9603, 11575, 11387, 6515, 383, 10946, 10338, 10925, 9516, 2561, 9248, 11489, 5989, 5931, 10860, 5884, 9448, 12029, 4249, 4721, 11411, 6516, 919, 9414, 4021, 2813, 6433, 4060, 6229, 9324, 8396, 3655, 4038, 11401, 11391, 6624, 6965, 1187, 7778, 9525, 5290, 4589, 1770, 9836, 1847, 5239, 11924, 4889, 8212, 1707, 5735, 4974, 2531, 449, 2768, 12064, 9859, 10323, 3459, 4735, 9661, 384, 1189, 7548, 5661, 11844, 9595, 6749, 1936, 6998, 11774, 2877, 3385, 2207, 9872, 4350, 11077, 9953, 455, 2552, 8605, 9946, 6442, 7246, 3157, 10849, 4656, 1667, 9455, 1555, 8596, 5495, 888, 8049, 11028, 3015, 10324, 2961, 2816, 9379, 8914, 5548, 6966, 8344, 8972, 8966, 224, 6524, 7962, 7014, 4269, 11969, 9655, 6309, 11034, 2971, 417, 2194, 9184, 8810, 2677, 763, 7385, 8099, 1985, 11618, 4343, 4646, 4330, 2255, 3333, 4466, 6455, 7587, 7483, 6205, 4553, 5597, 3179, 6977, 6462, 6934, 7464, 11732, 9158, 7192, 4401, 6097, 11916, 640, 9047, 1129, 6235, 7792, 10154, 7615, 11712, 4726, 6950, 4287, 5438, 3839, 3522, 8654, 287, 11696, 6806, 2209, 8790, 8208, 9387, 7654, 10043, 11137, 3879, 11513, 11394, 335, 3681, 5862, 5871, 3232, 91, 6080, 3237, 4310, 6144, 12168, 10215, 8661, 10679, 10909, 2373, 7161, 7496, 11050, 6570, 555, 11779, 1676, 3613, 8205, 7877, 2609, 3911, 11342, 570, 8790, 11693, 6020, 2933, 5761, 7284, 1002, 8389, 8784, 2452, 5762, 3906, 7918, 4778, 461, 7072, 5622, 7193, 11329, 3073, ]
expected_hash_RIP = [201, 5505, 10597, 6550, 948, 2511, 53, 2174, 5714, 4253, 3581, 1478, 11509, 7802, 7651, 972, 8163, 11598, 11264, 449, 4657, 2381, 2768, 779, 3426, 1327, 10968, 6396, 8154, 3791, 944, 9678, 10448, 11356, 3232, 678, 4187, 10449, 8626, 807, 3099, 11710, 6264, 10098, 2440, 10057, 9811, 7992, 10905, 1326, 3243, 3844, 11035, 11740, 8155, 4195, 10376, 9533, 5132, 8373, 1931, 4452, 9414, 3128, 9859, 3609, 9489, 10448, 1958, 975, 2916, 9982, 9754, 10284, 5946, 3717, 1345, 3128, 5798, 4711, 2734, 7898, 8240, 9094, 323, 10085, 7433, 11656, 1419, 6303, 2492, 2030, 9792, 401, 6091, 8055, 2498, 1111, 5824, 11463, 10123, 8294, 3427, 9883, 8246, 2950, 5816, 369, 9010, 1522, 8270, 7878, 549, 2346, 8097, 2619, 4692, 10819, 2009, 4257, 5284, 11809, 8434, 4790, 8258, 5718, 4085, 8913, 11586, 8079, 9529, 4366, 7062, 5172, 2962, 7404, 3758, 7446, 11521, 2480, 4466, 4613, 3194, 9216, 204, 7707, 1349, 9073, 2121, 9233, 9192, 10919, 9065, 2534, 4563, 3418, 10835, 10199, 11132, 4269, 4397, 10574, 1451, 10447, 2807, 530, 9289, 7938, 7145, 6207, 6529, 10234, 3200, 643, 10712, 6672, 11186, 873, 7095, 1492, 11247, 303, 378, 97, 2688, 8200, 6420, 824, 4155, 9484, 2383, 4022, 7326, 5293, 2336, 8347, 6450, 4448, 11124, 9361, 8447, 1187, 10688, 11727, 3658, 507, 7582, 5679, 9003, 6524, 4351, 2295, 1361, 10846, 5923, 10186, 9448, 10267, 6997, 5927, 2858, 11031, 10606, 6039, 5699, 2891, 4353, 1742, 1196, 3172, 9935, 10172, 2793, 5122, 6017, 2460, 6205, 4887, 3327, 10682, 4366, 9661, 2554, 3639, 346, 5480, 3191, 6985, 4173, 3731, 9793, 11018, 3980, 2072, 11077, 2403, 10380, 3264, 10805, 2120, 2054, 2436, 428, 4368, 9511, 9407, 4093, 8835, 1089, 6607, 1937, 4653, 7564, 3557, 8459, 9239, 9694, 4567, 5543, 8721, 5652, 1600, 1001, 6232, 3595, 7925, 9014, 7800, 1123, 6396, 8983, 1803, 6510, 4148, 1415, 3025, 6689, 1408, 7377, 3748, 9436, 466, 2341, 10675, 9042, 10381, 9871, 3012, 11965, 8080, 11132, 1334, 10097, 6752, 5806, 4973, 11264, 6123, 9459, 10194, 819, 10895, 2539, 2115, 5978, 2453, 3418, 8151, 6543, 7987, 7106, 2854, 1493, 11817, 11160, 5900, 2885, 3040, 251, 6438, 8440, 6776, 4291, 7483, 6842, 1128, 12127, 542, 9897, 5256, 797, 6977, 5306, 8841, 5230, 11405, 2521, 10295, 9902, 11658, 6587, 2674, 12276, 6318, 10527, 9214, 9441, 3748, 9523, 1653, 10068, 10222, 9483, 2762, 7257, 2388, 7180, 9884, 5895, 10428, 1792, 12176, 431, 1628, 5542, 12129, 10437, 3784, 5338, 8415, 8401, 6378, 2863, 7668, 2539, 5624, 7533, 2031, 1712, 10879, 3318, 4318, 10411, 6524, 6845, 9081, 4631, 8322, 10955, 10936, 10278, 8430, 11565, 4829, 7233, 614, 9983, 9044, 11170, 1264, 5331, 3705, 5548, 216, 324, 5449, 7668, 6771, 1070, 4280, 9684, 6228, 9219, 5956, 5477, 9337, 6003, 5067, 2696, 8551, 1225, 8575, 757, 11672, 11972, 2999, 8354, 2828, 2225, 6521, 10085, 1508, 5434, 10086, 2560, 464, 2305, 11891, 4120, 10780, 3296, 1708, 361, 4702, 2879, 679, 2304, 5266, 9124, 4597, 1670, 1220, 11860, 5418, 6404, 3181, 2084, 9288, 524, 1703, 9013, 7639, 3571, 9403, 11177, 11906, 1307, 5781, 87, 11117, 7686, 6404, 4197, 3137, 4866, 5785, 299, 4523, 10994, 4904, 2535, 4695, 3770, 9589, 5681, 6276, 1378, 2703, 8503, 3932, 7406, 932]

prng = SHAKE.new(seed)
prng.flip()
n = 512
# we don't care about the secret key here
f = sign_KAT[n][0]["f"]
g = sign_KAT[n][0]["g"]
F = sign_KAT[n][0]["F"]
G = sign_KAT[n][0]["G"]
sk = SecretKey(n, [f, g, F, G])
pk = PublicKey(n, sk.h)

assert expected_hash_NIST == sk.hash_to_point(n, msg, salt, xof=SHAKE)
assert expected_hash_RIP  == sk.hash_to_point(n, msg, salt, xof=KeccakPRNG)

